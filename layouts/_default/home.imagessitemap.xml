{{/* https://dariusz.wieckiewicz.org/en/add-and-use-an-image-sitemap-with-hugo/ */}}

{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:image="https://www.google.com/schemas/sitemap-image/1.1">
  {{- range .Site.RegularPages -}}
    {{- if ne .Params.sitemap_exclude true -}}
      {{- if findRE `(?s)<img.+?>` .Content -}}
        {{- if .Permalink -}}
          <url>
            <loc>{{- .Permalink }}</loc>
            {{- if (findRE `(?s)<img.+?>` .Content) -}}
              {{- range $k, $_ := findRE `(?s)<img.+?>` .Content -}}
                {{- if $k -}}
                {{- end }}
                <image:image>
                  <image:loc>
                    {{ replaceRE `(?s).*src="(.+?)".*` "$1" . | absURL }}
                  </image:loc>
                </image:image>
              {{- end -}}
            {{- end }}
          </url>
        {{- end -}}
      {{ end }}
    {{ end }}
  {{ end }}
  
</urlset>
